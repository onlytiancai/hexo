---
title: '202406'
date: 2024-06-14 10:17:40
tags:
---

Python One Billion Row Challenge — From 10 Minutes to 4 Seconds
https://archive.is/a644q

Processing One Billion Rows in PHP!
https://dev.to/realflowcontrol/processing-one-billion-rows-in-php-3eg0

mysql 中如下 json 字段

    {
       "status": "OK",
       "results": [
          {
             "types": [
                "locality",
                "political"
             ],
             "place_id": "ChIJpdtYF6azhkcRmu5nCgU7BtM",
             "formatted_address": "20874 Busnago, Province of Monza and Brianza, Italy",
             "address_components": [
                {
                   "types": [
                      "locality",
                      "political"
                   ],
                   "long_name": "Busnago",
                   "short_name": "Busnago"
                },
                {
                   "types": [
                      "administrative_area_level_3",
                      "political"
                   ],
                   "long_name": "Busnago",
                   "short_name": "Busnago"
                },
                {
                   "types": [
                      "administrative_area_level_2",
                      "political"
                   ],
                   "long_name": "Province of Monza and Brianza",
                   "short_name": "MB"
                },
                {
                   "types": [
                      "administrative_area_level_1",
                      "political"
                   ],
                   "long_name": "Lombardy",
                   "short_name": "Lombardy"
                },
                {
                   "types": [
                      "country",
                      "political"
                   ],
                   "long_name": "Italy",
                   "short_name": "IT"
                },
                {
                   "types": [
                      "postal_code"
                   ],
                   "long_name": "20874",
                   "short_name": "20874"
                }
             ]
          }
       ]
    }

要取 types 里包含 administrative_area_level_3 的上级节点的 long_name 值

    select 
        country_code,
        location,response->>'$.results[0].formatted_address' formatted_address,
        json_unquote(
            json_extract(
                response,
                concat(
                    '$.results[0]',
                    REGEXP_REPLACE(
                        JSON_SEARCH(
                            response->>'$.results[0]',
                            'one', 
                            'administrative_area_level_1'
                        ),
                        '"|\\$|\\.types\\[[0-9]]',''
                    ),
                    '.long_name')
            )
        ) administrative_area_level_1 
    from t limit 10;

1. 先用 JSON_SEARCH 得到 `administrative_area_level_1` 的路径，类似 `$.address_components[3].types[0]`
2. 用 REGEXP_REPLACE 替换掉前面的 `$` 和最后的 `.types[0]`
3. 用 concat 拼接所需的 json path，类似 `$.results[0].address_components[2].long_name`
4. 用 json_extract 取出所需要的值
5. 用 json_unquote 去掉结果两侧的引号
